# Copy git repository to S3 on commit

## Introduction

This template provides an AWS Lambda backed API that receives git webhook events. When an event is received the repo is copied into a zip file and placed in a versioned S3 bucket. This is useful for integrating different git providers (BitBucket, GitHub Enterprise, etc) with AWS services like CodePipeline and CodeBuild. More detail is available on the [AWS DevOps blog](https://aws-blogs-prod.amazon.com/devops/integrating-git-with-aws-codepipeline/).

## Usage

The contents of the CreateSSHKey, DeleteBucketContents, GitPullS3 and ZipDl folders need to be zipped and placed into an S3 bucket in the same region as you intend to launch the template from. The bucket name and path must then be updated in the LambdaBuckets mapping in the template.

The template can then be launched in CloudFormation, the following parameters are available:

* **OutputBucketName:**
The name of the bucket where your zipped code will be uploaded. CloudFormation will create a bucket with this name. For this reason, you cannot use the name of an existing S3 bucket.
***Note:*** *By default, there is no lifecycle policy on this bucket, so previous versions of your code will be retained indefinitely.  If you want to control the retention period of previous versions, see [Lifecycle Configuration for a Bucket with Versioning](http://docs.aws.amazon.com/AmazonS3/latest/UG/lifecycle-configuration-bucket-with-versioning.html) in the Amazon S3 User Guide.*

* **AllowedIps:**
Used only with the git pull method. A comma-separated list of IP CIDR blocks used for Git provider source IP authentication. The Bitbucket Cloud IP ranges are provided as defaults.

* **ApiSecret:**
Used only with the git pull method. This parameter is used for webhook secrets in GitHub Enterprise and GitLab. If a secret is matched, IP range authentication is bypassed. The secret cannot contain commas (,), slashes (\), or quotation marks (â€œ).

* **GitToken:**
Used only with the zip download method. This is a personal access token generated by GitHub Enterprise or GitLab.

* **OauthKey/OuathSecret:**
Used only with the zip download method. This is an OAuth2 key and secret provided by Bitbucket.

Once stack creation is completed the outputs provides urls for a git pull method and a zip download method, as well as the name of the output bucket and an ssh public key that needs to be used as a deployment key when using the git pull method.

## Provided Lambda functions

#### CreateSSHKey

This function generates and ssh keypair that will be used by the GitPull function to authenticate to git. the private key is encrypted with KMS and stored in a dedicated S3 bucket.

#### DeleteBucketContents

As CloudFormation does not delete S3 bucket contents when a stack is deleted, this function removes the S3 keys and Code zips from S3 when the CloudFormation DeleteStack operation is called.

#### GitPullS3

This function backs the git pull method of the API, it uses the pygit2 library to perform a clone (over ssh) of the repository received in the event. This clone is then zipped and uploaded to S3.

#### ZipDl  

Backing the zip download api method, this function supports the api methods of BitBucket, GitHub Enterprise and GitLab to download an already zipped archive of the repo, which is then pushed to S3.
